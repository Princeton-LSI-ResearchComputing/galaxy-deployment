- name: set 503 to scheduled maintenance
  file: src={{ GALAXY_HOME }}/../www/html/error-documents/scheduled_maintenance.html
        dest={{ GALAXY_HOME }}/../www/html/error-documents/503.html
        state=link

# Reports

- name: Check if galaxy reports pid file exists.
  command: /usr/bin/test -e {{ GALAXY_HOME }}/reports_webapp.pid
  ignore_errors: True
  register: galaxy_reports_running

- name: stop galaxy reports
  become: yes
  become_user: galaxy
  become_method: sudo
  shell: "{{ GALAXY_HOME }}/run_reports.sh --stop-daemon"
  when: galaxy_reports_running.rc == 0

- name: Wait for Galaxy Reports to stop
  wait_for: port=9001 delay=5 state=stopped timeout=60

# Galaxy web application

- name: Check if galaxy pid file exists.
  command: /usr/bin/test -e {{ GALAXY_HOME }}/galaxy.pid
  ignore_errors: True
  register: galaxy_running

- name: stop galaxy
  become: yes
  become_user: galaxy
  become_method: sudo
  shell: "{{ GALAXY_HOME }}/run.sh --stop-daemon"
  when: galaxy_running.rc == 0

- name: Wait for Galaxy to stop
  wait_for: port=8080 delay=5 state=stopped timeout=60
